- block:

    - name: Collect installed package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Check if httpd is installed
      debug:
        msg: >-
          {{
            '✅ Apache インストールOK'
            if 'httpd' in ansible_facts.packages
            else '⚠️ httpd is NOT installed on this host'
          }}

    - name: Check if httpd is running
      ansible.builtin.systemd:
        name: httpd
        state: started
      register: httpd_status
      changed_when: false
      failed_when: httpd_status.status.ActiveState != 'active'

    - name: Confirm httpd is running
      debug:
        msg: >-
          {{
            '✅ Webサーバー起動OK'
            if httpd_status.status.ActiveState == 'active'
            else '⚠️ httpd is NOT running'
          }}

    - name: Check if httpd is enabled (auto-start on boot)
      ansible.builtin.systemd:
        name: httpd
        enabled: true
      register: httpd_enabled
      changed_when: false
      failed_when: not httpd_enabled.status.UnitFileState in ['enabled', 'static']

    - name: Confirm httpd is enabled
      debug:
        msg: >-
          {{
            '✅ Webサーバーの自動起動OK'
            if httpd_enabled.status.UnitFileState in ['enabled', 'static']
            else '⚠️ httpd is NOT enabled for auto-start'
          }}

    - name: Read /root/ps_httpd.out as plain text
      ansible.builtin.shell: cat /root/ps_httpd.out
      register: ps_text
      changed_when: false

    - name: Check if any line contains 'httpd'
      set_fact:
        httpd_lines: "{{ ps_text.stdout_lines | select('search', 'httpd') | list }}"

    - name: Confirm httpd process exists
      debug:
        msg: >-
          {{
            '✅ httpd プロセス確認のファイルOK'
            if httpd_lines | length > 0
            else '⚠️ No httpd process found in ps_httpd.out'
          }}

    - name: Find all files in /var/www/html
      ansible.builtin.find:
        paths: /var/www/html
        file_type: file
      register: html_files

    - name: Extract non-index.html files
      set_fact:
        non_index_files: >-
          {{
            html_files.files | rejectattr('path', 'search', 'index.html$') | list
          }}

    - name: Skip if non-index.html files exist
      debug:
        msg: "⚠️ /var/www/html contains files other than index.html → skipping content check"
      when: non_index_files | length > 0

    - name: Access Apache page if only index.html exists
      ansible.builtin.uri:
        url: http://localhost/
        return_content: yes
      register: apache_response
      when: non_index_files | length == 0 and html_files.matched > 0

    - name: Confirm 'Hello World' is in page content
      debug:
        msg: >-
          {{
            '✅ Hello World の出力を確認'
            if 'Hello World' in apache_response.content
            else '⚠️ Hello World NOT found in Apache page'
          }}
      when: apache_response is defined

  ignore_errors: yes
  tags: httpd
